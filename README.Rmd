---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# conmat

<!-- badges: start -->
[![Codecov test coverage](https://codecov.io/gh/njtierney/conmat/branch/master/graph/badge.svg)](https://codecov.io/gh/njtierney/conmat?branch=master)
[![R-CMD-check](https://github.com/njtierney/conmat/workflows/R-CMD-check/badge.svg)](https://github.com/njtierney/conmat/actions)
<!-- badges: end -->

The goal of conmat is to make it easy to generate synthetic contact matrices for a given age population.

**What is a contact matrix?**

Contact matrices describe the degree of contact between individuals of given age groups. These matrices are commonly used to model how diseases such as COVID-19 spread in a population through social contact. 

**Why do we need _synthetic_ contact matrices?**

Contact matrices are produced from empirical data resulting from a contact survey, which requires individuals to diary the amount and manner of contact a person has in a day. 

However, these surveys are highly time-consuming and expensive to run, meaning that only a handful of these empirical datasets exist globally. 

We can use statistical methods to create _synthetic contact matrices_, which are new contact matrices that have been generalised to new countries based on existing surveys.

**Why do we need `conmat`?**

Existing methods only provide outputs of the contact matrices for each country, or at best, for urban and rural areas for a given country. 

We need methods that allow for flexibly creating synthetic contact matrices for a specified age population, as the age population distribution of many countries (e.g., Australia), are quite heterogeneous, and assuming it is homogeneous would result in inaccurate representation of community infection in many regions.

## Installation

You can install the development version with:

```r
install.packages("conmat", repos = "https://njtierney.r-universe.dev")
```

Or alternatively you can use `remotes`

``` r
# install.packages("remotes")
remotes::install_github("njtierney/conmat")
```

## Example

First we want to fit the model to the POLYMOD data, which contains various survey and population data.

```{r get-polymod}
library(conmat)
polymod_contact_data <- get_polymod_setting_data()
polymod_survey_data <- get_polymod_population()
```

The contact data is a list of the contacts for each of the settings, "home", "work", "school", and "other". It contains a dataframe for each of these.

```{r show-polymod-str}
str(polymod_contact_data)
```

Say looking at the "home" setting, each row contains survey information of the number of contacts. Specifically, the number of contacts from one age group to another age group, and then the nuber of participants in that age group.

```{r show-polymod-home}
polymod_contact_data$home
```

The survey data contains the lower age limit and the population in that age group.

```{r show-polymod}
polymod_survey_data
```

We can create a model for each of the settings with the function `fit_setting_contacts`

```{r fit-polymod}
set.seed(2021-09-24)
setting_models <- fit_setting_contacts(
  contact_data_list = polymod_contact_data,
  population = polymod_survey_data
  )
```

This contains a list of models, one for each setting. We can look at one, and get summary information out:

```{r}
names(setting_models)
setting_models$home
```

So this gives us our baseline model of a contact model. We have fit this model to the existing contact survey data.

We can now predict to another age population, to create our "synthetic" contact matrix. Say we want to create a contact matrix for the "Fairfield" LGA, we can extract it out like so:

```{r get-fairfield}
library(conmat)
fairfield_age_pop <- abs_age_lga("Fairfield (C)")
fairfield_age_pop
```

Then we take the model we had earlier, and extrapolate to the fairfield data with `predict_setting_contacts`, also providing some age breaks we want to predict to

```{r fairfield-synth-5}
set.seed(2021-09-24)
synthetic_settings_5y_fairfield <- predict_setting_contacts(
  population = fairfield_age_pop,
  contact_model = setting_models,
  age_breaks = c(seq(0, 85, by = 5), Inf)
  )
```

This then returns a list of synthetic matrices, "home", "work", "school", "other", and "all", which is the sum of all matrices.

```{r}
str(synthetic_settings_5y_fairfield)
synthetic_settings_5y_fairfield$home
synthetic_settings_5y_fairfield$all
```

## Plotting

Looking at the matrices is nice, but let's plot them. We can use `plot_setting_matrix` to plot all at once

```{r fairfield-synth-5-plot}
# this code is erroring for the moment - something to do with rendering a large plot I think.
plot_setting_matrices(
  synthetic_settings_5y_fairfield,
  title = "Setting-specific synthetic contact matrices (fairfield 2020 projected)"
)
```

You can also plot individual matrices with `plot_matrix`

```{r plot-matrix-differents}
plot_matrix(synthetic_settings_5y_fairfield$home)
plot_matrix(synthetic_settings_5y_fairfield$all)
```


## Note 

The contact matrices created using this package are transposed when compared to the contact matrices discussed by [Prem](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005697) and [Mossong](https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074). That is, the rows are "age group to", and the columns are "age group from".

## Speeding up computation with `future`

`conmat` supports parallelisation, which is useful in a couple of contexts with the model fitting, here is an example:

```{r load-future}
library(future)
plan(multisession, workers = 4)
```

We set the future plan, saying "multisession", with 4 workers. Then we run the same code as above (note that you must specify the plan, otherwise it does not know how to parallelise. See the [future package documentation](https://future.futureverse.org/reference/plan.html) for more details):

```{r show-off-furrr}
polymod_setting_data <- get_polymod_setting_data()
polymod_population <- get_polymod_population()

contact_model <- fit_setting_contacts(
  contact_data_list = polymod_setting_data,
  population = polymod_population
)

contact_model_pred <- predict_setting_contacts(
  population = polymod_population,
  contact_model = contact_model,
  age_breaks = c(seq(0, 75, by = 5), Inf)
)
```

Notably this is about 3 times faster than without using that plan.

## Data sources

This package provides data and helper functions for the data, for use in calculating contact matrices. The data sources are from the Australian Bureau of Statistics (ABS), as we were using these a lot when we created the package. In the future we might wrap these data sources and helpers into another package, but for the time being they are here.

Below are a couple of examples of data provided, see the "data sources" vignette and helpful at the website for full details.

You can extract the age population structure for the LGA Fairfield, or Brisbane, like so:

```{r abs-age-lga}
abs_age_lga("Fairfield (C)")
abs_age_lga("Brisbane (C)")
```

Note that you need to use the exact LGA name - you can look up LGA names in the data set `abs_lga_lookup`:

```{r abs-lga-lookup}
abs_lga_lookup
```

Or get the information for states like so:

```{r abs-age-state}
abs_age_state(state_name = "QLD")
abs_age_state(state_name = "NSW")
```


## Code of Conduct

Please note that the conmat project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/0/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
